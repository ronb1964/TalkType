"""
TalkType Help Dialog - Shared help window for tray and preferences.
"""

import gi
gi.require_version('Gtk', '3.0')
from gi.repository import Gtk


def show_help_dialog():
    """Show help dialog with TalkType features and instructions."""
    print("üîµ USING SHARED help_dialog.py - NEW CODE")  # Debug message
    from gi.repository import Gdk

    dialog = Gtk.Dialog(title="TalkType Help")
    dialog.set_default_size(650, 550)

    # Use geometry hints to force exact size
    geo = Gdk.Geometry()
    geo.min_width = 650
    geo.max_width = 650
    geo.min_height = 550
    geo.max_height = 550
    dialog.set_geometry_hints(None, geo, Gdk.WindowHints.MIN_SIZE | Gdk.WindowHints.MAX_SIZE)

    dialog.set_resizable(False)
    dialog.set_modal(True)
    dialog.set_position(Gtk.WindowPosition.CENTER)

    content = dialog.get_content_area()
    content.set_margin_top(10)
    content.set_margin_bottom(10)
    content.set_margin_start(10)
    content.set_margin_end(10)

    # Create notebook (tabbed interface)
    notebook = Gtk.Notebook()
    notebook.set_tab_pos(Gtk.PositionType.TOP)
    content.pack_start(notebook, True, True, 0)

    # Helper function to create a tab with scrolled content
    def create_tab(title, markup_text):
        scrolled = Gtk.ScrolledWindow()
        scrolled.set_policy(Gtk.PolicyType.NEVER, Gtk.PolicyType.AUTOMATIC)
        scrolled.set_margin_top(15)
        scrolled.set_margin_bottom(15)
        scrolled.set_margin_start(20)
        scrolled.set_margin_end(20)

        label = Gtk.Label()
        label.set_markup(markup_text)
        label.set_line_wrap(True)
        label.set_xalign(0)
        label.set_valign(Gtk.Align.START)

        scrolled.add(label)
        tab_label = Gtk.Label(label=title)
        notebook.append_page(scrolled, tab_label)

    # Tab 1: Getting Started (merged best of tray + prefs)
    create_tab("üöÄ Getting Started", '''<span size="large"><b>Quick Start Guide</b></span>

<b>‚ú® TalkType is ready to use!</b>
The dictation service starts automatically when you launch TalkType.

<b>üéâ First-Run Setup</b>
On first launch, TalkType shows a welcome dialog that:
‚Ä¢ Tests your hotkeys (F8 and F9) to ensure they work
‚Ä¢ Offers to install GNOME extension (if on GNOME desktop)
‚Ä¢ Offers to download CUDA libraries (if NVIDIA GPU detected)
‚Ä¢ Adapts automatically to your system capabilities

<b>1. Begin Dictating</b>
Press <b>F8</b> (push-to-talk) or <b>F9</b> (toggle mode) to start
‚Ä¢ <b>F8:</b> Hold to record, release to stop
‚Ä¢ <b>F9:</b> Press once to start, press again to stop
‚Ä¢ <b>Recording Indicator:</b> A red microphone icon appears during active dictation

<b>2. Configure Settings</b>
Right-click ‚Üí "Preferences" to customize:
‚Ä¢ Hotkeys (F8/F9 or custom keys)
‚Ä¢ AI model (tiny to large-v3)
‚Ä¢ Language (auto-detect or select manually)
‚Ä¢ GPU acceleration (if you have NVIDIA GPU)
‚Ä¢ Text input method (keyboard or clipboard)

<b>3. Dictate!</b>
Press your hotkey and speak clearly at a normal pace.
Text will be inserted where your cursor is located.

<b>üí° Auto-Timeout Feature:</b>
The service automatically pauses after 5 minutes of inactivity to save
system resources. Adjust this in Preferences ‚Üí Advanced.

<b>Need more help?</b> Check the other tabs for detailed information.''')

    # Tab 2: Features
    create_tab("‚ú® Features", '''<span size="large"><b>Key Features</b></span>

<b>Dual Hotkey Modes</b>
‚Ä¢ F8 (push-to-talk) or F9 (toggle) - fully customizable
‚Ä¢ Visual recording indicator in system tray
‚Ä¢ Audio beeps for start/stop feedback

<b>Smart Text Processing</b>
‚Ä¢ Auto-punctuation for natural text flow
‚Ä¢ Smart quotes (" " instead of " ")
‚Ä¢ Auto-spacing before new text
‚Ä¢ Optional auto-period at end of sentences

<b>Language Support</b>
‚Ä¢ Auto-detect language from speech
‚Ä¢ Manually select from 50+ supported languages
‚Ä¢ Great for multilingual users

<b>Flexible Text Input</b>
‚Ä¢ Keystroke simulation (ydotool/wtype)
‚Ä¢ Clipboard paste mode (for apps with input issues)

<b>Audio Control</b>
‚Ä¢ Microphone selection and testing
‚Ä¢ Audio level monitoring
‚Ä¢ Volume adjustment support

<b>System Integration</b>
‚Ä¢ Launch at login option
‚Ä¢ System tray integration
‚Ä¢ Notification sounds (optional)
‚Ä¢ Desktop notifications (optional)''')

    # Tab 3: AI Models
    create_tab("ü§ñ AI Models", '''<span size="large"><b>Choosing the Right AI Model</b></span>

Configure in: Preferences ‚Üí General ‚Üí Model

<b>Available Models:</b>

<b>‚Ä¢ tiny (39 MB)</b>
  Speed: ‚ö°‚ö°‚ö°‚ö°‚ö° Fastest
  Accuracy: ‚≠ê‚≠ê Basic
  Best for: Quick notes, casual use

<b>‚Ä¢ base (74 MB)</b>
  Speed: ‚ö°‚ö°‚ö°‚ö° Fast
  Accuracy: ‚≠ê‚≠ê‚≠ê Good
  Best for: Casual dictation

<b>‚Ä¢ small (244 MB)</b>
  Speed: ‚ö°‚ö°‚ö° Balanced
  Accuracy: ‚≠ê‚≠ê‚≠ê‚≠ê Very good
  Best for: General use (recommended)

<b>‚Ä¢ medium (769 MB)</b>
  Speed: ‚ö°‚ö° Slower
  Accuracy: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excellent
  Best for: Professional dictation

<b>‚Ä¢ large-v3 (~3 GB)</b>
  Speed: ‚ö° Slowest
  Accuracy: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Best possible
  Best for: Technical/professional work
  ‚ö†Ô∏è Takes 30-60 seconds to load initially, 10-20 seconds after

<b>Benefits of Larger Models:</b>
‚Ä¢ Better recognition of uncommon words and technical terms
‚Ä¢ More accurate with proper nouns and acronyms
‚Ä¢ Improved punctuation and capitalization
‚Ä¢ Better handling of accents and background noise
‚Ä¢ Superior context awareness (e.g., "their" vs "there")
‚Ä¢ More natural sentence structure

<b>Recommendation:</b>
Start with "small" for everyday use. Upgrade to "medium" or "large-v3"
if you need better accuracy for professional or technical dictation.''')

    # Tab 4: Advanced
    create_tab("‚öôÔ∏è Advanced", '''<span size="large"><b>Advanced Features</b></span>

<b>üéÆ GPU Acceleration</b>
If you have an NVIDIA graphics card, enable GPU acceleration for 3-5x faster transcription:
‚Ä¢ On first run with NVIDIA GPU, you'll be offered to download CUDA libraries (~800MB)
‚Ä¢ After download completes, click OK or Apply in Preferences to activate GPU mode
‚Ä¢ Device automatically switches to "CUDA (GPU)" - no manual selection needed
‚Ä¢ GPU mode significantly reduces transcription time (3-5x faster)
‚Ä¢ Allows use of larger models without slowdown
‚Ä¢ Can also download CUDA later: Preferences ‚Üí Advanced ‚Üí "Download CUDA Libraries"

<b>üîã Power Management</b>
TalkType includes intelligent timeout to save system resources:
‚Ä¢ <b>Auto-timeout:</b> Service stops automatically after inactivity
‚Ä¢ <b>Configurable:</b> Set duration in Preferences ‚Üí Advanced
‚Ä¢ <b>Smart detection:</b> Timer resets when you use hotkeys
‚Ä¢ <b>Battery friendly:</b> Reduces CPU/GPU usage when idle

Configure in: Preferences ‚Üí Advanced Tab

<b>üìù Text Injection Modes</b>
Choose how text is inserted (Preferences ‚Üí Advanced):
‚Ä¢ <b>Keyboard Simulation (default):</b> Types text using ydotool/wtype
‚Ä¢ <b>Clipboard Paste:</b> Copies to clipboard then simulates Ctrl+V
  Use this if keyboard simulation doesn't work in certain apps

<b>üéõÔ∏è Audio Settings</b>
Fine-tune audio in Preferences ‚Üí Audio tab:
‚Ä¢ Select specific microphone
‚Ä¢ Test audio levels
‚Ä¢ Adjust input volume (PulseAudio systems)
‚Ä¢ Enable/disable audio beeps''')

    # Tab 5: Voice Commands
    create_tab("üó£Ô∏è Voice Commands", '''<span size="large"><b>Voice Commands Reference</b></span>

Use these spoken commands during dictation to insert punctuation and formatting.

<b>Punctuation:</b>
‚Ä¢ Say <b>comma</b> for ,
‚Ä¢ Say <b>period</b> or <b>full stop</b> for .
‚Ä¢ Say <b>question mark</b> for ?
‚Ä¢ Say <b>exclamation point</b> or <b>exclamation mark</b> for !
‚Ä¢ Say <b>semicolon</b> for ;
‚Ä¢ Say <b>colon</b> for :
‚Ä¢ Say <b>apostrophe</b> for '
‚Ä¢ Say <b>quote</b> for regular "
‚Ä¢ Say <b>open quote</b> or <b>open quotes</b> for "
‚Ä¢ Say <b>close quote</b> or <b>close quotes</b> for "
‚Ä¢ Say <b>hyphen</b> or <b>dash</b> for -
‚Ä¢ Say <b>em dash</b> for ‚Äî
‚Ä¢ Say <b>dot dot dot</b> or <b>ellipsis</b> for ‚Ä¶

<b>Brackets &amp; Parentheses:</b>
‚Ä¢ Say <b>open parenthesis</b> for (
‚Ä¢ Say <b>close parenthesis</b> for )
‚Ä¢ Say <b>open bracket</b> for [
‚Ä¢ Say <b>close bracket</b> for ]
‚Ä¢ Say <b>open brace</b> for {
‚Ä¢ Say <b>close brace</b> for }

<b>Formatting:</b>
‚Ä¢ Say <b>new line</b>, <b>newline</b>, <b>return</b>, or <b>line break</b> for a line break
‚Ä¢ Say <b>new paragraph</b> or <b>paragraph break</b> for a double line break
‚Ä¢ Say <b>tab</b> for a tab character (indent)
‚Ä¢ Say <b>soft break</b> or <b>soft line</b> for three spaces

<b>Literal Words:</b>
To prevent conversion to punctuation, say:
‚Ä¢ <b>literal period</b> ‚Üí outputs the word "period" (not .)
‚Ä¢ <b>the word period</b> ‚Üí outputs the word "period" (not .)

<b>Usage Examples:</b>
Say: <i>Hello world comma how are you question mark</i>
Result: Hello world, how are you?

Say: <i>First sentence period new line Second sentence exclamation point</i>
Result: First sentence.
Second sentence!

Say: <i>The temperature is 98 point 6 degrees</i>
Result: The temperature is 98.6 degrees

Say: <i>Use the literal period command</i>
Result: Use the period command

<b>Smart Features:</b>
‚Ä¢ Auto-capitalization after sentences
‚Ä¢ Trailing commas converted to periods before line breaks
‚Ä¢ Auto-period added if sentence has no punctuation
‚Ä¢ Smart quote placement and spacing''')

    # Tab 6: Tips
    create_tab("üí° Tips", '''<span size="large"><b>Tips &amp; Troubleshooting</b></span>

<b>Getting Best Results:</b>
‚Ä¢ Speak clearly at a normal pace
‚Ä¢ Use a quality microphone for better accuracy
‚Ä¢ Minimize background noise
‚Ä¢ Pause briefly at sentence ends for better punctuation

<b>Audio Setup:</b>
‚Ä¢ Use the microphone test in Preferences to check levels
‚Ä¢ Adjust input volume if audio is too quiet or distorted
‚Ä¢ Select the correct microphone if you have multiple inputs

<b>Status Indicators:</b>
‚Ä¢ Tray icon tooltip shows running or stopped status
‚Ä¢ Red microphone icon appears during recording
‚Ä¢ Audio beeps indicate recording start/stop (can be disabled)

<b>Common Issues:</b>

<b>Hotkey not working:</b>
‚Ä¢ Check if another app is using the same hotkey
‚Ä¢ Try a different key in Preferences
‚Ä¢ Ensure service is running

<b>Text not inserting:</b>
‚Ä¢ Make sure cursor is in a text field
‚Ä¢ Try clipboard paste mode (Preferences ‚Üí Advanced)
‚Ä¢ Check if the app has special input restrictions

<b>Transcription too slow:</b>
‚Ä¢ Enable GPU acceleration if you have NVIDIA GPU
‚Ä¢ Try a smaller AI model (tiny/base/small)
‚Ä¢ Check if other programs are using GPU/CPU

<b>Service won't start:</b>
‚Ä¢ Check logs: ~/.config/talktype/talktype.log
‚Ä¢ Restart from tray menu: Stop Service then Start Service
‚Ä¢ Ensure all dependencies are installed

<b>Convenience Features:</b>
‚Ä¢ Enable Launch at Login to start automatically
‚Ä¢ Use toggle mode (F9) for hands-free extended dictation
‚Ä¢ Set auto-timeout to save battery when not in use''')

    # Close button
    close_button = Gtk.Button(label="Close")
    close_button.connect("clicked", lambda w: dialog.destroy())
    dialog.add_action_widget(close_button, Gtk.ResponseType.CLOSE)

    dialog.show_all()
    dialog.run()
    dialog.destroy()
